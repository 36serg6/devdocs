<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Custom Fastly VCL snippets | Magento 2 Developer Documentation</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">
	<meta http-equiv="last-modified" content="" />

	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,700,600,300,800' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="/css/app.css" />
	<link rel="stylesheet" href="/css/print.css" media="print" />
	<link rel="canonical" href="//guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">

    <!-- WebUI popover css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.webui-popover/1.2.1/jquery.webui-popover.min.css">

  <script>
    var baseUrl = "/";
  </script>

	<!-- crazyegg -->
	<script type="text/javascript">
	setTimeout(function(){var a=document.createElement("script");
	var b=document.getElementsByTagName("script")[0];
	a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0038/0321.js?"+Math.floor(new Date().getTime()/3600000);
	a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
	</script>

    <!-- heap analytics -->
    <script type="text/javascript">
        window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
        heap.load("2619540280");
    </script>

	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body>

<header class="site-header">

	<nav id="global-nav">

		<div class="menu-btn"><a class="menu-trigger menu-icon" href="#" data-proofer-ignore></a></div>

		<div class="container">

			<a class="logo" href="/"><img src="/i/m-logo.svg" alt=""><img src="/i/magento-logo.svg" alt="Magento" class="magento-logo" /><img src="/i/devdocs-logo.svg" alt="Devdocs" class="devdocs-logo" /></a>

			
<div class="version-switcher dropdown" data-version="2.2">
	<button id="version-switcher-button" class="btn btn-small dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Magento 2.2
	</button>

	<ul class="dropdown-menu dropdown-menu-left" aria-labelledby="version-switcher-button">
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.0/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.1/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.1</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">Magento 2.2</a></li>
	
  </ul>

</div>



			<nav class="nav-main" role="menubar">

  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Setup</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          <li><a href="/guides/v2.2/install-gde/bk-install-guide.html">Installation Guide</a></li>
          
          <li><a href="/guides/v2.2/comp-mgr/bk-compman-upgrade-guide.html">Extension Update and System Upgrade Guide</a></li>
          
          <li><a href="/guides/v2.2/config-guide/bk-config-guide.html">Configuration Guide</a></li>
          <li><a href="/guides/v2.2/migration/bk-migration-guide.html">Migration Guide</a></li>
          <li><a href="/guides/v2.2/cloud/bk-cloud.html">Magento Commerce (Cloud) Guide</a></li>
          <li><a href="/magento-release-information.html">Release Information</a></li>
      </ul>
    </div>

  </div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Development</a>

    <div class="nav-popup" role="menu" aria-hidden="true">

      <div class="nav-section">
        <div class="nav-section-title">Backend</div>
        <ul>
          <li><a href="/guides/v2.2/architecture/bk-architecture.html">Architecture Guide</a></li>
          <li><a href="/guides/v2.2/extension-dev-guide/bk-extension-dev-guide.html">PHP Developer Guide</a></li>
          <li><a href="/guides/v2.2/ext-best-practices/bk-ext-best-practices.html">Extension Developer Best Practices</a></li>
          <li><a href="/guides/v2.2/mrg/intro.html">Module Reference Guide</a></li>
          <li><a href="/guides/v2.2/coding-standards/bk-coding-standards.html">Coding Standards</a></li>
          <li><a href="/guides/v2.2/contributor-guide/contributing.html">Contributor Guide</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Frontend</div>
        <ul>
          <li class=""><a href="/guides/v2.2/frontend-dev-guide/bk-frontend-dev-guide.html">Frontend Developer Guide</a></li>
          
          <li><a href="/guides/v2.2/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript Developer Guide</a></li>
          <li><a href="/guides/v2.2/pattern-library/bk-pattern.html">Admin Design Pattern Library</a></li>
          <li><a href="/guides/v2.2/design-styleguide/bk-styleguide.html">Admin Style Guide</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title"><abbr>API</abbr></div>
        <ul>
          <li><a href="/guides/v2.2/get-started/bk-get-started-api.html">Get Started with Magento Web APIs</a></li>
          <li><a href="/guides/v2.2/rest/bk-rest.html">REST API Reference</a></li>
          <li><a href="/guides/v2.2/soap/bk-soap.html">SOAP API Reference</a></li>
        </ul>
      </div>
    </div>

  </div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Testing</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/test/testing.html">Magento Testing Guide</a></li>
        
        <li><a href="/guides/v2.2/mtf/mtf_introduction.html">Functional Testing</a></li>
        <li><a href="/guides/v2.2/test/integration/integration_test_execution.html">Integration Testing</a></li>
        <li><a href="/guides/v2.2/test/js/jasmine.html">JavaScript Unit Testing</a></li>
        <li><a href="/guides/v2.2/test/unit/unit_test_execution.html">PHP Unit Testing</a></li>
        <li><a href="/guides/v2.2/get-started/web-api-functional-testing.html">Web API Functional Testing</a></li>
      </ul>
    </div>

  </div>


  <div class="nav-main-separator"></div>


  <div class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Functional Areas</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        
        <li class="leaf"><a href="/guides/v2.2/b2b/bk-b2b.html">B2B</a></li>
        
        <li><a href="/guides/v2.2/howdoi/checkout/checkout_overview.html">Checkout</a></li>
        <li><a href="/guides/v2.2/payments-integrations/bk-payments-integrations.html">Payment Integrations</a></li>
        
      </ul>
    </div>

  </div>


  <div class="nav-main-item"  tabindex="0" role="menuitem" aria-haspopup="true">
    <a href="#" data-proofer-ignore tabindex="-1">Tutorials</a>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/howdoi/bk-how-do-i.html">How To</a></li>
        <li><a  data-proofer-ignore href="/guides/v2.2/get-started/order-tutorial/order-intro.html">Order Processing with REST APIs</a></li>
        <li><a href="/videos/">Video Tutorials</a></li>
      </ul>
    </div>

  </div>

</nav><!-- /.nav-main -->


			<div class="search-btn">
				<a class="search-trigger search-icon" href="/search.html"></a>
			</div>

			<form class="quick-search" action="/guides/v2.2/search.html" method="get">
				<input type="search" name="q" placeholder="Search" autocomplete="off" />
				<a href="#" data-proofer-ignore class="quick-search-close">&times;</a>
			</form>

		</div>

	</nav><!-- #global-nav -->

</header>
<div class="nav-main-fader"></div>


<div id="gl-wrapper">

	<!-- .main-container -->
	<div class="main-container">
		<a id="main-content"></a>


<div class="container">

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" data-proofer-ignore class="toc-toggler">Table of Contents</a>
	<div class="sidebar-wrapper">



<h4></h4>
<div class="left-navigation">
    <ul>
    
    

<li class="nav-level1  " id="welcome-to-magento-commerce-(cloud)">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/bk-cloud.html">Welcome to Magento Commerce (Cloud)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="subscriptions-and-plans">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/cloud-plans.html">Subscriptions and plans</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="starter-architecture">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/starter-architecture.html">Starter architecture</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="starter-develop-and-deploy-workflow">
            
            
        
            
            <a href="/guides/v2.2/cloud/basic-information/starter-develop-deploy-workflow.html">Starter develop and deploy workflow</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="pro-architecture">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/discover-arch.html">Pro architecture</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="pro-develop-and-deploy-workflow">
            
            
        
            
            <a href="/guides/v2.2/cloud/welcome/discover-workflow.html">Pro develop and deploy workflow</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="onboarding-tasks">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/onboarding/onboarding-tasks.html">Onboarding tasks</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="onboarding-portal-management">
            
            
        
            
            <a href="/guides/v2.2/cloud/onboarding/onboarding-portal.html">Onboarding Portal management</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="prepare-project-environments">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-project-owner.html">Prepare project environments</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="technologies-and-requirements">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/requirements/cloud-requirements.html">Technologies and requirements</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="composer">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/cloud-composer.html">Composer</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="magento-cloud-cli">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/cli-ref-topic.html">Magento Cloud CLI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="github">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-integrate-github.html">GitHub</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="ssh-and-sftp">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environments-ssh.html">SSH and sFTP</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="new-relic-apm">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/new-relic.html">New Relic APM</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="blackfire-profiler">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-integrate-blackfire.html">Blackfire Profiler</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="local-environment-setup">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/access-acct/first-time-setup.html">Local environment setup</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="prepare-for-local-environment-setup">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace.html">Prepare for local environment setup</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-magento-prerequisites">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-magento-prereqs.html">Install Magento prerequisites</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="enable-ssh-keys">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-ssh.html">Enable SSH keys</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-the-magento-file-system-owner">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-workspace-file-sys-owner.html">Set up the Magento file system owner</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="clone-and-branch-the-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-setup-env-2_clone.html">Clone and branch the project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-magento">
            
            
        
            
            <a href="/guides/v2.2/cloud/before/before-setup-env-install.html">Install Magento</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="first-time-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/first-time-deploy.html">First time deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="optional---install-sample-data">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/sample-data.html">Optional - Install sample data</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="optional---configure-a-php-debugger,-xdebug">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/debug.html">Optional - Configure a PHP debugger, Xdebug</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="import-an-existing-magento-project">
            
            
            <div class="toggle closed">&nbsp;</div>
            
        
            
            <span>Import an existing Magento project</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="first-steps-for-importing-magento-commerce">
                    

                    
                    <a  href="/guides/v2.2/cloud/access-acct/first-time-setup_import-first-steps.html">First steps for importing Magento Commerce</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="find-the-information-you-need-for-your-import">
                    

                    
                    <a  href="/guides/v2.2/cloud/access-acct/first-time-setup_import-prereq.html">Find the information you need for your import</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="prepare-your-existing-magento-commerce-system">
                    

                    
                    <a  href="/guides/v2.2/cloud/access-acct/first-time-setup_import-prepare.html">Prepare your existing Magento Commerce system</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="import-magento-commerce-into-magento-commerce-(cloud)">
                    

                    
                    <a  href="/guides/v2.2/cloud/access-acct/first-time-setup_import-import.html">Import Magento Commerce into Magento Commerce (Cloud)</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-your-store">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/configure/configuration-overview.html">Configure your store</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="set-up-paypal">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/paypal-onboarding.html">Set up PayPal</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-magento-b2b">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/setup-b2b.html">Set up Magento B2B</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-cron-jobs">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/setup-cron-jobs.html">Set up cron jobs</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-multiple-cloud-websites-or-stores">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-multi-sites.html">Set up multiple Cloud websites or stores</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-and-update-extensions">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/install-components.html">Install and update extensions</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="install-a-theme">
            
            
        
            
            <a href="/guides/v2.2/cloud/howtos/custom-theme.html">Install a theme</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-fastly">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Configure Fastly</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="set-up-fastly">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/fastly.html">Set up Fastly</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2 active " id="custom-fastly-vcl-snippets">
            
            
        
            
            <a href="/guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html">Custom Fastly VCL snippets</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="fastly-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_fastly.html">Fastly troubleshooting</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configure-environments">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/env/environments.html">Configure environments</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="configure-.magento.app.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_magento-app.html">Configure .magento.app.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-services---services.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services.html">Configure services - services.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-mysql-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-mysql.html">Set up MySQL service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-redis-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-redis.html">Set up Redis service</a>
            

            
        </li>
        
        
        
        
        
        
        <li class="nav-level2  " id="set-up-elasticsearch-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-elastic.html">Set up Elasticsearch service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="set-up-rabbitmq-service">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_services-rabbit.html">Set up RabbitMQ service</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="configure-routes---routes.yaml">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-conf-files_routes.html">Configure routes - routes.yaml</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="caching">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-cache.html">Caching</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="redirects">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-redir.html">Redirects</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="server-side-includes">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-routes-more-ssi.html">Server side includes</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="configuration-management-for-store-settings">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/sens-data-over.html">Configuration management for store settings</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="example-of-managing-system-specific-settings">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/sens-data-initial.html">Example of managing system-specific settings</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="manage-your-project">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/project/projects.html">Manage your project</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="configure-your-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-basic.html">Configure your project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="project-structure">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-start.html">Project structure</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="create-and-manage-users">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/user-admin.html">Create and manage users</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-branches-with-the-interface">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-branch.html">Manage branches with the Interface</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="manage-branches-with-the-cli">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environments-start.html">Manage branches with the CLI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="snapshots-and-backup-management">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-webint-snap.html">Snapshots and backup management</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="manage-variables">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/env/environment-vars_over.html">Manage variables</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento-application-environment-variables">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environment-vars_magento.html">Magento application environment variables</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="magento-commerce-(cloud)-environment-variables">
            
            
        
            
            <a href="/guides/v2.2/cloud/env/environment-vars_cloud.html">Magento Commerce (Cloud) environment variables</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="upgrades-and-patches">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/project/project-upgrade-parent.html">Upgrades and Patches</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="upgrade-magento-commerce-(cloud)">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-upgrade.html">Upgrade Magento Commerce (Cloud)</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="patch-magento-commerce-(cloud)">
            
            
        
            
            <a href="/guides/v2.2/cloud/project/project-patch.html">Patch Magento Commerce (Cloud)</a>
            

            
        </li>
        
        
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="deploy-your-store">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/stage-prod-live.html">Deploy your store</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="deployment-process">
            
            
        
            
            <a href="/guides/v2.2/cloud/reference/discover-deploy.html">Deployment process</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="continuous-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/deploy/continuous-deployment.html">Continuous deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="protective-block">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/live-prot.html">Protective block</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="build-and-deploy-on-local">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/live-sanity-check.html">Build and deploy on local</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="prepare-to-deploy-to-staging-and-production">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-migrate-prereq.html">Prepare to deploy to Staging and Production</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="deploy-code-and-migrate-static-files-and-data">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-migrate.html">Deploy code and migrate static files and data</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="test-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/stage-prod-test.html">Test deployment</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="go-live-and-launch">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/live/live.html">Go live and launch</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="go-live-checklist">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/go-live-checklist.html">Go live checklist</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="launch-steps">
            
            
        
            
            <a href="/guides/v2.2/cloud/live/launch-steps.html">Launch steps</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    

<li class="nav-level1  " id="troubleshooting">

    
    <div class="toggle closed">&nbsp;</div>
    
    
    
    <a href="/guides/v2.2/cloud/trouble/trouble.html">Troubleshooting</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="add-staging-and-production-to-pro-projects-ui">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/pro-env-management.html">Add Staging and Production to Pro projects UI</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="troubleshoot-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/access-acct/trouble.html">Troubleshoot deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="view-logs-for-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/environments-logs.html">View logs for troubleshooting</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="incorrect-credentials">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_ce-creds.html">Incorrect credentials</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-a-new-project">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_proj-startover.html">Resolve issues with a new project</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="component-deployment-failure">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble_comp-deploy-fail.html">Component deployment failure</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="redis-troubleshooting">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/redis-troubleshooting.html">Redis troubleshooting</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-encryption-key">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-crypt-key-variable.html">Resolve issues with encryption key</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-html-minification">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-error-html-minification.html">Resolve issues with HTML minification</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="resolve-issues-with-google-analytics-during-deployment">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/trouble-google-analytics-deploy.html">Resolve issues with Google Analytics during deployment</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="add-sitemap-and-robots.txt">
            
            
        
            
            <a href="/guides/v2.2/cloud/trouble/robots-sitemap.html">Add sitemap and robots.txt</a>
            

            
        </li>
        
        
    </ul>
    
</li>


    
    </ul>
</div>

	</div>

</aside>


<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <a class="breadcrumb-item" href="/"><span>Home</span></a>

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

    <!-- Iteration breadcrumb item -->
    
    

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">

        
          <a property="item" typeof="WebPage" href="/guides/v2.2/cloud/bk-cloud.html">
            <span property="name">Welcome to Magento Commerce (Cloud)</span>
          </a>
        

        <meta property="position" content="1" />
      </li>

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">

        

          

          <span property="name">Custom Fastly VCL snippets</span>

        

        <meta property="position" content="2" />
      </li>

    

    



    </ol>

  </nav>



	

	

	<h1 class="page-heading">Custom Fastly VCL snippets</h1>

  


</section>


			<p><a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Fastly</a> and Magento Commerce (Cloud) support creating custom Varnish Configuration Language (VCL) snippets. For best results, we recommend creating Edge Dictionaries and Edge ACLs for your VCL snippets. You’re free to customize your Fastly VCL snippets any way you like to complete custom code. The following examples and instructions walk through creating edge dictionaries, edge ACLs, and VCL snippets.</p>

<p>To create and upload these VCL snippets, you use a terminal application. You do not need to SSH into a specific environment. This information includes a walk-through creating regular snippets with <a href="#vcl-curl"><code class="highlighter-rouge">curl</code> commands</a>. <em>Don’t worry, we walk you through the process with examples.</em></p>

<p>You need the following information to create VCL snippets:</p>

<ul>
  <li>Fastly Service ID for Staging and Production to assign the snippets to a specific service or environment</li>
  <li>Fastly API key used for the <code class="highlighter-rouge">FASTLY_API_TOKEN</code> in the commands</li>
</ul>

<div class="bs-callout bs-callout-info" id="info">
  <p>The default VCL snippets you uploaded included a prepended name of <code class="highlighter-rouge">magentomodule_</code> with a priority of 50. For your custom VCL snippets, do not use the <code class="highlighter-rouge">magentomodule_</code> name. Also consider the priority of your custom snippets if they should override the default snippets.</p>
</div>

<p>For Fastly resources on creating VCL snippets, see:</p>

<ul>
  <li><a href="https://docs.fastly.com/guides/vcl/" target="_blank">All Fastly VCL content</a></li>
  <li><a href="https://docs.fastly.com/guides/vcl/guide-to-vcl" target="_blank">Fastly VCL guide</a></li>
  <li><a href="https://docs.fastly.com/guides/vcl/mixing-and-matching-fastly-vcl-with-custom-vcl" target="_blank">Mixing and matching Fastly VCL with custom VCL</a></li>
  <li><a href="https://docs.fastly.com/api/config#snippet" target="_blank">Fastly VCL snippet object values</a></li>
</ul>

<p>Fastly supports two types of snippets. We recommend and document how to create and use regular snippets.</p>

<ul>
  <li><a href="https://docs.fastly.com/guides/vcl-snippets/using-regular-vcl-snippets" target="_blank">Regular snippets</a> are versioned VCL snippets. The code and settings are locked per version to create, modify, and deploy with the Fastly service.</li>
  <li><a href="https://docs.fastly.com/guides/vcl-snippets/using-dynamic-vcl-snippets" target="_blank">Dynamic snippets</a> are snippets you can only create via API calls. These snippets do not have a version and deploy separately from your Fastly service.</li>
</ul>

<h2 id="process">The VCL snippet process</h2>
<p>How do you create and add snippets? Here’s the process:</p>

<ol>
  <li>Get the <a href="#list">list</a> of all VCL snippet versions and look for active version</li>
  <li><a href="#clone">Clone</a> the currently active VCL snippet version. When you clone, a new version is generated.</li>
  <li><a href="#update">Modify</a> snippets in the cloned version or <a href="#create-snippet">add VCL snippets</a></li>
  <li><a href="#validate">Validate</a> all VCL snippets for the version number</li>
  <li><a href="#validate">Activate</a> all VCL snippets for the version number</li>
</ol>

<p>We provide more information on <a href="#edge-dictionary">Edge Dictionaries</a>, <a href="#edge-acl">Edge ACLs</a>, and <a href="#examples">custom VCL snippets</a> to get you started.</p>

<div class="bs-callout bs-callout-info" id="info">
  <p>If you want to override values and settings from the <a href="https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets" target="_blank">default Fastly VCL snippets</a>, we recommend creating a new snippet with updated values and code with a higher priority value of 100.</p>
</div>

<h3 id="vcl-curl">VCL snippet values</h3>
<p>What you should know about the <code class="highlighter-rouge">curl</code> command and JSON values:</p>

<ul>
  <li><code class="highlighter-rouge">Service ID</code>: The ID indicates the specific Staging or Production service/environment. We provide this value.</li>
  <li><code class="highlighter-rouge">FASTLY_API_TOKEN</code>: The API Key for your Fastly account. We provide this value.</li>
  <li><code class="highlighter-rouge">Editable Version #</code>: The version of the service you add snippets to for validating and activating. We also use the description of <code class="highlighter-rouge">Cloned Version #</code> in the examples.</li>
  <li><code class="highlighter-rouge">type</code>: Specifies the location to place the generated snippet such as <code class="highlighter-rouge">init</code> (above subroutines) and within subroutines like <code class="highlighter-rouge">recv</code>. See <a href="https://docs.fastly.com/api/config#snippet" target="_blank">Fastly VCL snippet object values</a> for information on these values.</li>
  <li><code class="highlighter-rouge">content</code>: The snippet of VCL code to run</li>
  <li><code class="highlighter-rouge">priority</code>: Determines the order VCL snippets call. Lower values run first, from 1 to 100. All Magento module uploaded snippets are 50. If you want an action to occur last or override Magento default VCL snippets, enter a higher number like 100. To have code occur immediately, enter a lower value like 5.</li>
  <li><code class="highlighter-rouge">dynamic</code>: Indicates if this is a <a href="https://docs.fastly.com/guides/vcl-snippets/using-dynamic-vcl-snippets" target="_blank">dynamic snippet</a></li>
  <li><code class="highlighter-rouge">active</code>: Indicates if the snippet or version is activated and currently in use. Returns <code class="highlighter-rouge">true</code> or <code class="highlighter-rouge">false</code>.</li>
</ul>

<p>All default VCL snippets have a priority of 50. Priorities will call VCL snippets starting from 1 to 100. Any VCL snippet at priority 5 will run immediately, best for blacklists, whitelists, and redirects. Priority 100 is best for overriding default VCL snippet code and values, best for extending timeouts. If you do not set a priority with your <code class="highlighter-rouge">curl</code> command, the default value set is 100.</p>

<h3 id="list">Locate the currently active VCL snippet version</h3>
<p>To view an entire list of all VCL snippets by version, use the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>Look for the <code class="highlighter-rouge">active</code> key from the returned list. This is the version you will clone in the next section.</p>

<p>For more information on this Fastly API, see this <a href="https://docs.fastly.com/api/config#version_dfde9093f4eb0aa2497bbfd1d9415987" target="_blank">get version command</a>.</p>

<h3 id="clone">Clone the active VCL version and all snippets</h3>
<p>Clone the version using the active version number. This creates a copy of all existing VCL snippets for that version with a new version number. After you clone the version, you can <a href="#create-snippet">add</a> more VCL snippets or <a href="#update">modify</a> current snippets.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X PUT https://api.fastly.com/service/{Service ID}/version/{Current Active Version #}/clone
</code></pre></div></div>

<p>For more information on this Fastly API, see this <a href="https://docs.fastly.com/api/config#version_7f4937d0663a27fbb765820d4c76c709" target="_blank">clone command</a>.</p>

<!-- They should clone then edit. Saving this info just in case.
### Get a service version number {#version-number}
When creating a new regular VCL snippet, or updating a current one, you need a new version number. This version is a new service configuration version number for your Fastly service. When adding VCL snippets, you add them all to a specific version of the service. You may have noticed the versioning when you upload VCLs during Fastly configuration through the Fastly module.

When you validate and activate your snippets, you actually activate a version. All snippets assigned to the version activate.

To generate the version, use the following command with your Service ID and API key in the command:

	curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version

Fastly returns the editable version number and Service ID. You use the version number when creating, calling, and managing VCL snippets. For example:

	{
		"number":1,
		"service_id": "SU1Z0isxPaozGVKXdv0eY"
	}

When reviewing a list of VCL snippets, you will also note the snippets have a specific version number in the JSON output. -->

<h3 id="create-snippet">Add new regular VCL snippets for the cloned version</h3>
<p>Create one or more VCL snippets for the cloned version using <code class="highlighter-rouge">curl</code> commands.</p>

<p>We recommend typing out your <code class="highlighter-rouge">curl</code> command in a text editor to make sure everything is correct before entering it in a terminal. You can always copy and paste the command when ready to enter it.</p>

<p>When you assign VCL snippets to the version, you can then <a href="#validate">validate and activate</a> all snippets for that version. When activated, all snippets for that new version are active.</p>

<p>Use the following command as a template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "{VCL Name}", "type": "Type", "dynamic": 0, "priority": 100, "content": "{VCL snippet code}"}'
</code></pre></div></div>

<p>After you run the <code class="highlighter-rouge">curl</code> command, Fastly returns a JSON response with the data. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "id": "62Yd1WfiCBPENLloXfXmlO",
  "service_id": "{Service ID}",
  "version": "{Editable Version #}",
  "name": "apply_acl",
  "priority": "100",
  "dynamic": "1",
  "type": "hit",
  "content": "if ((client.ip ~ {ACLNAME}) &amp;&amp; !req.http.Fastly-FF){ error 403; }",
  "created_at": "2016-08-15T09:37:10+00:00",
  "updated_at": "2016-08-15T09:37:10+00:00",
  "deleted_at": null
}
</code></pre></div></div>

<h3 id="update">Update an existing VCL snippet</h3>
<p>Locate the snippet you want to update from the list of snippets included in the cloned version. You can use the following command to list the snippets:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Cloned version #&gt;/snippet/ -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>Copy the data and build a <code class="highlighter-rouge">curl</code> command with the cloned version number, name, and edits. The following is an example template for the update command. You would enter the cloned version number for <code class="highlighter-rouge">Editable Version #</code> and data for the command in <code class="highlighter-rouge">--data</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X PUT -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN" -H 'Content-Type: application/x-www-form-urlencoded' --data $'content=if ( req.url ) {\n set req.http.my-snippet-test-header = \"affirmative\";\n}';
</code></pre></div></div>

<p>If you want to override values and settings from the <a href="https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets" target="_blank">default Fastly VCL snippets</a>, we recommend creating a new snippet with updated values and code with a priority of 100 (overrides the defaults).</p>

<h3 id="validate">Validate and activate snippets for a version</h3>
<p>When you add the VCL snippet(s) to the version, Fastly creates and assigns it to your service per that version number. Next, you should verify the entered VCL snippet(s) validates with Fastly. Use the following command to validate all snippets for the version:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X GET https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/validate
</code></pre></div></div>

<p>Fastly should return: <code class="highlighter-rouge">"status": "ok"</code>. If you received an OK, activate the version for that service.</p>

<p>Assuming no errors (if there are errors, fix them before proceeding), the last step is to activate the version with the following command. All VCL snippets associated with the version activate.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X PUT https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/activate
</code></pre></div></div>

<p>If your received errors back from Fastly, track down the errors and update the specific snippet with the following command. Make sure to use the same version number you are working to activate.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X PUT -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN" -H 'Content-Type: application/x-www-form-urlencoded' --data $'content=if ( req.url ) {\n set req.http.my-snippet-test-header = \"affirmative\";\n}';
</code></pre></div></div>

<p>For more information on these Fastly APIs, see <a href="https://docs.fastly.com/api/config#version_97f8cf7bfd5dc2e5ea1933d94dc5a9a6" target="_blank">validate</a> and <a href="https://docs.fastly.com/api/config#version_0b79ae1ba6aee61d64cc4d43fed1e0d5" target="_blank">activate</a> commands.</p>

<h2 id="manage-vcl">Manage regular VCL snippets with curl</h2>
<p>To review an individual snippet, enter the following API call in a terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>To list all regular VCL snippets attached to a service, enter the following API call in a terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X GET -s https://api.fastly.com/service/&lt;Service ID&gt;/version -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<p>To update a custom VCL snippet using the API, list the snippet then enter a <code class="highlighter-rouge">curl</code> command with the specific snippet version, name, and edits:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X PUT -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN" -H 'Content-Type: application/x-www-form-urlencoded' --data $'content=if ( req.url ) {\n set req.http.my-snippet-test-header = \"affirmative\";\n}';
</code></pre></div></div>

<p>If you want to override values and settings from the <a href="https://github.com/fastly/fastly-magento2/tree/master/etc/vcl_snippets" target="_blank">default Fastly VCL snippets</a>, we recommend creating a new snippet with updated values and code with a priority of 100 (overrides the defaults).</p>

<p>To delete an individual VCL snippet using the API, get a list of snippets and enter a <code class="highlighter-rouge">curl</code> command with the speicific snippet information to delete. We recommend keeping a copy of the creation command and JSON if you need to recreate it later.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X DELETE -s https://api.fastly.com/service/&lt;Service ID&gt;/version/&lt;Editable Version #&gt;/snippet/&lt;Snippet Name e.g my_regular_snippet&gt; -H "Fastly-Key:FASTLY_API_TOKEN"
</code></pre></div></div>

<h2 id="edge-dictionary">Create edge dictionary</h2>
<p>Edge Dictionaries create key-value pairs for running against your VCL snippet. For example, you may want to build a dictionary of bad referring domains to block from your site. First, you would create the Edge Dictionary, then create a <a href="#bad-refer">custom VCL snippet</a> using it.</p>

<ol>
  <li>Log in to the Magento Admin.</li>
  <li>Navigate to <strong>Stores</strong> &gt; <strong>Configuration</strong> &gt; <strong>Advanced</strong> &gt; <strong>System</strong> &gt; <strong>Fastly Configuration</strong>.</li>
  <li>Expand the <strong>Edge dictionaries</strong> section.</li>
  <li>Click <strong>Add container</strong>. You need to create a container to hold up to 1,000 key-value pairs.</li>
  <li>On the container, enter a Dictionary name. For this example, use the name for referers.</li>
  <li>Select the checkbox for <strong>Activate after the change</strong> if you want to the dictionary after creating or editing the container.</li>
  <li>Add key-value pairs in the new dictionary. For this example, enter the domains for bad refering websites you want to block from your site. Enter a value of 1.</li>
</ol>

<p>You can use the Edge Dictionary by name in your VCL snippet code.</p>

<p>For more information on using Edge Dictionaries with your VCL snippets, see Fastly’s <a href="https://docs.fastly.com/guides/edge-dictionaries/creating-and-using-dictionaries" target="_blank">Creating and using Edge Dictionaries</a> and their example <a href="https://docs.fastly.com/guides/edge-dictionaries/creating-and-using-dictionaries#custom-vcl-examples" target="_blank">custom VCL snippets</a>.</p>

<h2 id="edge-acl">Create edge ACL</h2>
<p>Edge ACLs create IP lists for managing access for your VCL snippet. For example, you may want to create ACLs of IPs to whitelist or blacklist for access to your site. You can create an Edge ACL for whitelist IPs and another for blacklist IPs. Then create custom VCL snippets to manage access by providing normal access, redirecting to a specific location, or <a href="#block-ip">displaying a 403 Forbidden message</a>.</p>

<ol>
  <li>Log in to the Magento Admin.</li>
  <li>Navigate to <strong>Stores</strong> &gt; <strong>Configuration</strong> &gt; <strong>Advanced</strong> &gt; <strong>System</strong> &gt; <strong>Fastly Configuration</strong>.</li>
  <li>Expand the <strong>Edge ACL</strong> section.</li>
  <li>Click <strong>Add ACL</strong> to create a list.</li>
  <li>Enter IP values in the list. Optionally, select the Negated checkbox if needed.</li>
</ol>

<p>You can use the Edge ACL by name in your VCL snippet code.</p>

<p>While we walk through the process of creating ACLs through the module for your VCL snippets, you can also manually manage the ACL along with the VCL in code. For more information on using manually added ACLs with your VCL snippets, see Fastly’s <a href="https://docs.fastly.com/guides/access-control-lists/manually-creating-access-control-lists" target="_blank">Manually creating access control lists</a>.</p>

<h2 id="examples">Example VCL snippets</h2>
<p>The following are example regular VCL snippets using Edge Dictionaries and Edge ACLs. When creating your custom VCL snippet code, you may want to review the following references:</p>

<ul>
  <li><a href="https://docs.fastly.com/guides/vcl/vcl-regular-expression-cheat-sheet" target="_blank">Fastly’s VCL regular expression cheat sheet</a></li>
  <li><a href="https://docs.fastly.com/guides/vcl/guide-to-vcl#fastlys-vcl-extensions" target="_blank">Fastly’s VCL extensions</a></li>
</ul>

<h3 id="bad-refer">Create a block bad referers VCL</h3>
<p>You may want to create a VCL snippet that runs before all other modules to block bad referring websites from accessing your site. To block these sites with a 403 Forbidden error through Fastly, create a VCL snippet to use with an Edge Dictionary of domains to block.</p>

<p>Of note for this snippet, you want to set the priority to 5 to immediate run and block the bad referers. This priority runs the snippet immediately and before any of the uploaded and default Magento VCL snippets (magentomodule) that have a priority of 50. The name for the Edge Dictionary is also <code class="highlighter-rouge">referer_blocklist</code>. If the domain matches the dictionary, it is blocked from access.</p>

<p>The following is an example of this VCL code from Fastly:</p>

<ul>
  <li>Name: <code class="highlighter-rouge">block_bad_referers</code></li>
  <li>Type: <code class="highlighter-rouge">recv</code>, puts the code in the subroutine vcl_recv</li>
  <li>Priority: 5</li>
  <li>
    <p>Content:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># capture host of referer into a header
  set req.http.Referer-Host = regsub(req.http.Referer, "^https?://?([^:/\s]+).*$", "\1");
# check if referrer host is in blocklist table
  if (table.lookup(referer_blocklist, req.http.Referer-Host)) {
      error 403 "Forbidden";
  }
</code></pre></div>    </div>
  </li>
</ul>

<p>The curl command would look like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "block_bad_referers", "type": "recv", "dynamic": 0, "priority": 5, "content": "set req.http.Referer-Host = regsub(req.http.Referer, "^https?://?([^:/\s]+).*$", "\1"); if (table.lookup(referer_blocklist, req.http.Referer-Host)) { error 403 "Forbidden"; }"}'
</code></pre></div></div>

<p><a href="#validate">Validate and activate</a> the version to activate the snippet.</p>

<h3 id="block-ip">Create a block blacklisted IPs VCL</h3>
<p>You may want to create a blacklist of IPs to block from accessing your site. You can create an Edge ACL list of the blacklisted IPs with a VCL snippet. The code checks the IP of the incoming IP address. If it matches a member of the ACL, it is blocked with a 403 Forbidden error.</p>

<p>Of note for this snippet, you want to set the priority to 5 to immediately run and block those blacklisted IPs. This priority runs the snippet immediately and before any of the uploaded and default Magento VCL snippets (magentomodule) that have a priority of 50. The name for the Edge ACL is also <code class="highlighter-rouge">blocklist</code>. If the domain matches the dictionary, it is blocked from access.</p>

<ul>
  <li>Name: <code class="highlighter-rouge">block_bad_ips</code></li>
  <li>Type: <code class="highlighter-rouge">recv</code>, puts the code in the subroutine vcl_recv</li>
  <li>Priority: 5</li>
  <li>
    <p>Content:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ( client.ip ~ blocklist) {
  error 403 "Forbidden";
  }
</code></pre></div>    </div>
  </li>
</ul>

<p>The curl command would look like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "block_bad_ips", "type": "recv", "dynamic": 0, "priority": 5, "content": "if ( client.ip ~ blocklist) { error 403 "Forbidden"; }"}'
</code></pre></div></div>

<p><a href="#validate">Validate and activate</a> the version to activate the snippet.</p>

<h3 id="whitelist-ip">Create a whitelist VCL</h3>
<p>You may want to create a whitelist of IPs to allow accessing your Magento Admin console. You can create an Edge ACL list of the whitelisted IPs with a VCL snippet. The code checks the IP of the incoming IP address. If it matches a member of the ACL, it is allowed access. All other IPs receive a 403 Forbidden error.</p>

<p>Of note for this snippet, you want to set the priority to 5 to immediately run and check for whitelisted IPs. This priority runs the snippet immediately and before any of the uploaded and default Magento VCL snippets (magentomodule) that have a priority of 50. The name for the Edge ACL is also <code class="highlighter-rouge">whitelist</code>. If the domain matches the dictionary, it is allowed access to a path of <code class="highlighter-rouge">/admin</code>. If you changed your Magento Admin path, use that value in this code example.</p>

<p>In the code sample, the condition <code class="highlighter-rouge">!req.http.Fastly-FF</code> is important when using Origin Shielding.</p>

<ul>
  <li>Name: <code class="highlighter-rouge">whitelist_admin</code></li>
  <li>Type: <code class="highlighter-rouge">recv</code>, puts the code in the subroutine vcl_recv</li>
  <li>Priority: 5</li>
  <li>
    <p>Content:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      if ((req.url ~ "^/admin") &amp;&amp; !(client.ip ~ whitelist) &amp;&amp; !req.http.Fastly-FF) {
          error 403 "Forbidden";
          }
</code></pre></div>    </div>
  </li>
</ul>

<p>The curl command would look like the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "block_bad_ips", "type": "recv", "dynamic": 0, "priority": 5, "content": "if ((req.url ~ "^/admin") &amp;&amp; !(client.ip ~ whitelist) &amp;&amp; !req.http.Fastly-FF) { error 403 "Forbidden"; }"}'
</code></pre></div></div>

<p><a href="#validate">Validate and activate</a> the version to activate the snippet.</p>

<h3 id="admin-timeout">Extend Magento Admin timeout on Fastly</h3>
<p>Fastly has a strict timeout for the Magento Admin of three minutes. This may not be enough time for some extended actions. To extend the default timeout for the Magento Admin, you will create a new VCL snippet with a priority of 100 and a longer timeout value. This VCL snippet value will run last and override the default value in <code class="highlighter-rouge">pass.vcl</code> with a priority of 50 (already uploaded to your service).</p>

<p>To build the new command, we can take the default code and revise it with a new name and lower priority value. The order of priorities will use this value over the default 180 seconds. How did you set the default timeout? When you first uploded your VCL snippets when configuring Fastly, you uploaded a default VCL with a default timeout of 180 seconds (three minutes). The VCL snippet uploaded was from this <a href="https://github.com/fastly/fastly-magento2/blob/master/etc/vcl_snippets/pass.vcl" target="_blank">Fastly pass.vcl snippet</a>. The important code that sets the timeout is the <code class="highlighter-rouge">first_byte_timeout</code> value:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Deactivate gzip on origin
unset bereq.http.Accept-Encoding;

# Increase first byte timeouts for /admin* URLs to 3 minutes
if ( req.url ~ "^/(index\.php/)?admin(_.*)?/" ) {
	set bereq.first_byte_timeout = 180s;
	}
</code></pre></div></div>

<p>For this snippet, modify the <code class="highlighter-rouge">set bereq.first_byte_timeout</code> with a higher value. For example, 300s for five minutes or 600s for ten minutes. Ten minutes is the hard cap for Fastly timeouts.</p>

<p>To create a new snippet, use the following <code class="highlighter-rouge">curl</code> command. This version sets the timeout to 600s (ten minutes).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "block_bad_ips", "type": "pass", "dynamic": 0, "priority": 5, "content": "if ( req.url ~ "^/(index\.php/)?admin(_.*)?/" ) { set bereq.first_byte_timeout = 600s; }"}'
</code></pre></div></div>

<p><a href="#validate">Validate and activate</a> the version to activate the snippet.</p>

<h3 id="dif-backend">Choose a different backend VCL</h3>
<p>You may have a separate Wordpress blog for all of your store’s blog entries, kept separate from your store. For this example, you are trying to check the first part of the incoming path and redirect the visitor to your Wordpress backend. You would create an Edge Dictionary called <code class="highlighter-rouge">wordpress_urls</code> with a list of paths.</p>

<p>This VCL snippet locates and extracts the first part of the path. For example, it extracts <code class="highlighter-rouge">mypath</code> from the <code class="highlighter-rouge">/mypath/someotherpath</code>. It then compares that path against the Edge Dictionary. If a match is found, the visitor is redirected to the Wordpress backend. For this snippet, you may want to use priority 5 to have the check runn immediately and redirect those visitors to the other backend.</p>

<p>The following is an example of this VCL code from Fastly:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Extract first part of the path: /mypath/someotherpath extracts mypath.
# Look up the path in the Wordpress URL lookup table and mark it as needed
# to be processed by Wordpress.
if ( req.url.path ~ "^\/?([^:\/\s]+).*$" ) {
 # check if first part of the url is in the wordpress urls table
 if ( table.lookup(wordpress_urls, re.group.1, "NOTFOUND") != "NOTFOUND" ) {
	 	set req.http.X-WP = "1";
		}
	}
</code></pre></div></div>

<p>For example, the command may look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Fastly-Key: {FASTLY_API_TOKEN}" -H 'Content-Type: application/json' -H "Accept: application/json" -X POST https://api.fastly.com/service/{Service ID}/version/{Editable Version #}/snippet -d '{"name": "wordpress_backend", "type": "recv", "dynamic": 0, "priority": 5, "content": "if ( req.url.path ~ "^\/?([^:\/\s]+).*$" ) { if ( table.lookup(wordpress_urls, re.group.1, "NOTFOUND") != "NOTFOUND" ) { set req.http.X-WP = "1"; } }"}
</code></pre></div></div>

<p>For this VCL snippet to work, you also need to attach a condition to the Wordpress backend to handle this request:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.http.X-WP == “1”
</code></pre></div></div>

<h4 id="related-topics">Related topics</h4>

<ul>
  <li><a href="/guides/v2.2/cloud/basic-information/cloud-fastly.html">Fastly in Cloud</a></li>
  <li><a href="/guides/v2.2/cloud/access-acct/fastly.html">Set up Fastly</a></li>
  <li><a href="/guides/v2.2/cloud/trouble/trouble_fastly.html">Troubleshoot Fastly</a></li>
</ul>

		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

  

  
   <div class="github-link">
     <a class="improve-page" href="https://github.com/magento/devdocs/tree/develop/guides/v2.0/cloud/configure/cloud-vcl-custom-snippets.md" target="_blank">
       Edit this page on GitHub
     </a>
   </div>
  

  <div class="new-issue">
    <a href="https://github.com/magento/devdocs/issues/new?title=&body=Feedback on page: /guides/v2.2/cloud/configure/cloud-vcl-custom-snippets.html" target="_blank">Give us feedback</a>
  </div>

</div>


	</section>
	<!-- /.content -->

</div> <!-- /.container -->


	</div>
	<!-- /.main-container -->

</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div id="footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav">
        <li><a href="/guides/v2.2/contributor-guide/contributing_docs.html">Become a Contributor</a>
        <li><a href="https://magento.github.io/glossary/index.html?audience=developer">Glossary</a></li>
        <li><a href="http://magento.com/legal/terms/privacy/">Privacy Policy</a></li>
        <li><a href="http://magento.com/legal/terms/">Terms of Service</a></li>
        <li><a href="http://magento.com/legal/licensing/">License/Trademark FAQ</a></li>
        <li><a href="/guides/v2.2/release-notes/bk-release-notes.html">Release Notes</a></li>
        <li><a href="/magento-third-party.html">Third-Party Licenses</a></li> 
      </ul>
    </div>

		<div class="copyright-date">&copy; 2017 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/common/js/app.min.js"></script>

<!-- Glossary integration -->
<script src="https://cdn.jsdelivr.net/jquery.webui-popover/1.2.1/jquery.webui-popover.min.js"></script>
<script src="/common/js/glossary.tooltip.min.js"></script>
<script>
    $(document).ready(function(){
      magento.glossary.init("https://magento.github.io/glossary/data/content-glossary.xml",function(term){return term.types.includes("glossary");},magento.glossary.tooltip.init);
      });
</script>

<script type="text/javascript">
    (function() {
        var didInit = false;
        function initMunchkin() {
            if(didInit === false) {
                didInit = true;
                Munchkin.init('585-GGD-959', {cookieAnon: false});
            }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
            if (this.readyState == 'complete' || this.readyState == 'loaded') {
                initMunchkin();
            }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>



<!--Google Analytics-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-66243208-1', 'auto');
    ga('send', 'pageview');
</script>


</body>
</html>

